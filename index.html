<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Home</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
        <link type="text/css" rel="stylesheet" href="main.css">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" integrity="sha512-dLxUelApnYxpLt6K2iomGngnHO83iUvZytA3YjDUCjT0HDOHKXnVYdf3hU4JjM8uEhxf9nD1/ey98U3t2vZ0qQ==" crossorigin="anonymous"></script>
		<script src="https://unpkg.com/postprocessing@6.22.0"></script>
        <script src="OrbitControls.js"></script>
        <script src="GLTFLoader.js"></script>
        <script src="RGBELoader.js"></script>
        <script src="RoughnessMipmapper.js"></script>
        <script src="EffectComposer.js"></script>
        <script src="RenderPass.js"></script>
        <script src="UnrealBloomPass.js"></script>
        <script src="LuminosityHighPassShader.js"></script>
        <script src="CopyShader.js"></script>
		<script src="ShaderPass.js"></script>
		<script src="XYZLoader.js"></script>
		<script src="WebGL.js"></script>
		<style>
			body {
				margin: 0;
				background-color: black;
			}

			@font-face {
			font-family: "Diatype";
			src: url("./fonts/ABC Diatype/ABCDiatype-Thin-Trial.woff2");
			}

			.LoadingContainer {
				width: 100%;
				height: 100%;
				position: absolute;
				top: 0;
				left: 0;
				background: #000;
				transition: opacity 1s ease;
			}

			.LoadingBox {
				position: absolute;
				top: 50%;
				width: 100%;
				transition: all 1s ease-out;
			}

			.LoadingMessage {
				color: #ffffff;
				font-family: "Diatype";
				width: 100%;
				text-align: center;
				font-size: 30px;
				margin-top: -75px;
				margin-bottom: 2rem;
			}
			#Counter {
				color: #ffffff;
				font-size: 12px;
			}

			.ProgressBar {
				position: relative;
				left: 40%;
				text-align: center;
				background: transparent;
				width: 20%;
				height: 50px;
				margin-left: -5px;
			}

			.Bar{
				background: rgba(255, 255, 255, 1);
				width: 0%;
				height: 30px;
				margin: 5px;
				transition: width 0.1s ease;
				border-radius: 60px;
			}

			.hidden{
				display: none!important;
			}

			.disappear{
				opacity: 0;
			}

			.modalContainer {
				width: 30%;
				height: 50%!important;
				position: absolute;
				top: 5%;
				left: 5%;
				height: 70%;
				background: rgba(0,0,0,0.7);
				color: #fff;
				border-radius: 25px;
				display: flex;
				flex-direction: column;
				justify-content: space-evenly;
				align-items: center;
				font-family: "Diatype";
				transition: opacity 0.5s ease-in-out;
			}
			.closeButtonContainer{
				width: 100%;
				display: flex;
				flex-direction: row;
				justify-content: flex-end;
			}
			.cross{
				display: flex;
				align-self: flex-end;
				margin-right: 15%;
				margin-top: 5%;
				margin-bottom: 5%;
				height: 30px;
			}
			.languageButtonContainer{
				display: flex;
				flex-direction: row;
				justify-content: flex-end;
				width: 100%;
				margin-right: 30%;
				margin-bottom: 5%;
				font-size: 12px;
			}
			.divisor{
				margin-left: 10px;
				margin-right: 10px;
			}
			.text{
				padding-left: 10%;
				padding-right: 15%;
				font-size: 12px;
				margin-bottom: 10%;
				text-align: right;
				min-height: 35%;
			}

			.blurred{
					text-shadow: 0px 0px 3px 3px white;
				}

			@media (max-width: 900px){
				.modalContainer {
					padding: 40px 0px 40px 0px;
					width: 70%;
					height: 100%;
				}
				.text {
					font-size: 12px;
					}
				.languageButtonContainer {
					font-size: 12px;
				}
				.cross{
				height: 25px;
				margin-right: 15%;
				margin-bottom: 5%;
				}

			}

		</style>
    </head>

	<body>
		<div class="modalContainer" id="modalContainer">
			<div id="closeBtn" class="closeButtonContainer">
				<img  class="cross" src="./close.svg" alt="Close" />
			</div>
			<div class="languageButtonContainer">
				<div class="lang es" id="es">ES</div>
				<div class="divisor">|</div>
				<div class="lang en" id="en">EN</div>
			</div>
			<div class="text" id="text"> </div>
		</div>

		<div id="loadingContainer" class="LoadingContainer">
			<div class="LoadingBox">
				<div class="LoadingMessage">
				Loading assets <span id="Counter"></span>
				</div>
				<div class="ProgressBar">
					<div id="progress" class="Bar"></div>
				</div>
			</div>
		</div>

		<video autoplay muted loop class="hidden" id="myVideo">
			<source src="videos/PRadera_Eco_Montaña.mp4" type="video/mp4">
		</video>

		<script type="module">

			let idioma = {
				es: "Como artista digital, combino tecnologías para crear experiencias que borren los límites entre el mundo físico y onírico. Compongo universos imaginarios, explorando herramientas que me permitan generar entornos sintéticos, estéticos y estimulantes. Me interesa la práctica artística como espacio interactivo y la experiencia audiovisual como investigación de la relación humana con la máquina",
				en: "As a digital artist, I combine different technologies to create experiences that blur the boundaries between the physical and the dream world. I explore tools that allow me to generate synthetic, aesthetic and stimulating surroundings and create imaginary universes. I am interested in the practice of art as an interactive space and the audiovisual experience as an investigation into the relationship between human and machine."
			}

			function onClose () {
				console.log("cierro")
				const modal = document.getElementById("modalContainer")
				modal.classList.add("disappear")
			}

			function changeLang(lang) {
				idioma[lang]
				document.getElementById("text").innerText = idioma[lang]
				const langElems = document.getElementsByClassName("lang")
				Array.from(langElems).forEach(el => el.classList.remove("blurred"))
				document.getElementById(lang).classList.add("blurred")
			}

			if ( THREE.WEBGL.isWebGLAvailable() ) {
				action();
			} else {
				console.log("No WebGL")
				const video = document.getElementById("myVideo");
				const loadingContainer = document.getElementById("loadingContainer");
				video.classList.remove("hidden");
				loadingContainer.classList.add("hidden")
			}

			const closeBtn = document.getElementById("closeBtn")
			closeBtn.addEventListener("click", onClose)

			document.getElementById("es").addEventListener("click", () => changeLang("es"))

			document.getElementById("en").addEventListener("click", () => changeLang("en"))
			changeLang("es")

			function action(){

				let camera, scene, model, renderer, composer, clock, animClock, mixer;
				let heartScene;
				let heartObject;
				let bloomEffect;
				let mouseX = 0;
				let mouseY = 0;
				let windowHalfX = window.innerWidth / 2;
				let windowHalfY = window.innerHeight / 2;
				let points;
				let INTERSECTED;

				const pointer = new THREE.Vector2();
				const raycaster = new THREE.Raycaster();

				init();

				function init() {
					//on loading progress bar
					const progressElement = document.getElementById("progress")
					const loadingContainerElement = document.getElementById(
						"loadingContainer"
					)
					const counterEl = document.getElementById("Counter");

					function onEnter() {
						console.debug("onEnter")
						progressElement.style.width = 0
						progressElement.style.opacity = 1
					}

					function onProgress(xhr, lastItem, item) {
						console.debug(xhr)
						console.debug("onProgress")
						let contentLength;
						if (xhr.lengthComputable) {
							contentLength = xhr.total;
						} else {
							contentLength = parseInt(xhr.target.getResponseHeader('content-length'), 10);
						}
						const progress = Math.min(100, (xhr.loaded / contentLength) * 100)
						console.debug("progress:", progress)
						counterEl.innerText = `${item} / 3`;
						if (lastItem && progress >= 100) {
							console.debug("finished!")
							progressElement.style.width = "100%"
							setTimeout(() => {
								loadingContainerElement.style.opacity = 0
							}, 500)
							setTimeout(() => {
								loadingContainerElement.style.display = "none"
							}, 1500)
						} else {
							progressElement.style.width = progress + "%"
						}
					}

					//

					const container = document.createElement( 'div' );
					document.body.appendChild( container );

					clock = new THREE.Clock();
					clock.start()

					animClock = new THREE.Clock();
					animClock.start()

					camera = new THREE.PerspectiveCamera( 45, window.innerWidth / window.innerHeight, 0.25, 20 );
					camera.position.set(0,-1,2)

					scene = new THREE.Scene();

					renderer = new THREE.WebGLRenderer( {
						powerPreference: "high-performance",
						antialias: false,
						stencil: false,
						depth: false
					} );
					renderer.setPixelRatio( window.devicePixelRatio );
					renderer.setSize( window.innerWidth, window.innerHeight );
					renderer.toneMapping = THREE.ACESFilmicToneMapping;
					renderer.toneMappingExposure = 1;
					renderer.outputEncoding = THREE.sRGBEncoding;
					container.appendChild( renderer.domElement );

					const pmremGenerator = new THREE.PMREMGenerator( renderer );
					pmremGenerator.compileEquirectangularShader();

					// Render passes and composer
					const renderScene = new POSTPROCESSING.RenderPass( scene, camera );

					bloomEffect = new POSTPROCESSING.SelectiveBloomEffect(scene,camera)
					bloomEffect.luminanceMaterial.threshold = 0.05
					bloomEffect.luminanceMaterial.smoothing = 1
					bloomEffect.intensity = 4;
					bloomEffect.blurPass.kernelSize = POSTPROCESSING.KernelSize.SMALL;
					console.log("kernel size", bloomEffect.blurPass.kernelSize)
				
					const effectPass = new POSTPROCESSING.EffectPass(camera, bloomEffect)

					// const effectPass = new POSTPROCESSING.EffectPass(camera, new POSTPROCESSING.BokehEffect())

					composer = new POSTPROCESSING.EffectComposer( renderer );
					composer.addPass( renderScene );
					//composer.addPass( bloomPass );
					composer.addPass(effectPass);

					onEnter()

					// Load HDR
					new THREE.RGBELoader()
						.setDataType( THREE.UnsignedByteType )
						.setPath( 'textures/equirectangular/' )
						.load( 'circus_arena_2k.hdr', function ( texture ) {

							const envMap = pmremGenerator.fromEquirectangular( texture ).texture;
							//uncomment to see HDRI as background
							//scene.background = envMap;
							scene.environment = envMap;

							texture.dispose();
							pmremGenerator.dispose();

							// model

							// use of RoughnessMipmapper is optional
							const loader = new THREE.GLTFLoader().setPath( 'models/gltf/' );

							loader.load( 'ISLAv8.gltf', function ( gltf ) {
								loader.load( 'cora.gltf', function ( heartGltf ) {
									heartScene = heartGltf.scene;

									// Find heart object
									heartObject = heartScene.children.find(obj => obj.name === "Default");

									model = gltf.scene;
									model.position.set(0.25,-0.1,-1.75)
									heartScene.position.set(0.25, -0.1, -1.75)

									mixer = new THREE.AnimationMixer( model );
									window.gltf = gltf;
									const clip = gltf.animations[ 0 ];
									const anim = mixer.clipAction(clip)
									window.anim = anim;
									anim.reset().play();

									// Add to selection of selectivebloom
									// heartScene.children.forEach(( obj ) => {
									// 	bloomEffect.selection.add(obj)
									// })

									scene.add( model );
									scene.add( heartScene );

									const loader = new THREE.XYZLoader();
									loader.load( 'models/xyz/CHARCAS.xyz', function ( geometry ) {

										geometry.center();

										const vertexColors = ( geometry.hasAttribute( 'color' ) === true );

										const material = new THREE.PointsMaterial( { size: 0.004, vertexColors: vertexColors } );

										points = new THREE.Points( geometry, material );
										scene.add( points );
										points.scale.set(0.25,0.25,0.25)

									});

									render();
								}, (xhr) => onProgress(xhr, true, 3));
							}, (xhr) => onProgress(xhr, false, 2));
						}, (xhr) => onProgress(xhr, false, 1));

					window.addEventListener( 'resize', onWindowResize );

				}
				// lux con esfera para ver dnd está 
				const luxPos = new THREE.Vector3(0, 0.5, -1.75);

				const light = new THREE.PointLight( 0xffffff, 2.5, 50, 0.5 );
				light.position.copy(luxPos) ;
				scene.add( light );

				const geometry = new THREE.SphereGeometry( 0.125, 32, 16 );
				const material = new THREE.MeshBasicMaterial( { color: 0xffff00 } );
				const sphere = new THREE.Mesh( geometry, material );
				sphere.position.copy(luxPos) ;
				//scene.add( sphere );

				// onhover cambia el punto de vista de la cam
				document.addEventListener( 'mousemove', onDocumentMouseMove );

				document.addEventListener("click", onDocumentClick)

				function scale(v, min, max) {
					return v * (max - min) + min;
				}

				function onDocumentMouseMove( event ) {
					// for raycaster
					pointer.x = ( event.clientX / window.innerWidth ) * 2 - 1;
					pointer.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

					mouseX = scale(event.clientX /  window.innerWidth, -3, 3);
					// console.log(mouseX)
					mouseY = scale(event.clientY / window.innerHeight, 0.5, 2);
					//console.log(mouseY)
				}

				function onDocumentClick(event) {
					if (INTERSECTED) {
						window.location.href = "https://www.instagram.com/joaquina.s/?hl=en"
					}
				}

				function onWindowResize() {

					camera.aspect = window.innerWidth / window.innerHeight;
					camera.updateProjectionMatrix();

					renderer.setSize( window.innerWidth, window.innerHeight );
					composer.setSize( window.innerWidth, window.innerHeight );

				}

				//

				function render() {
					requestAnimationFrame( render );

					camera.position.x += ( - mouseX - camera.position.x ) * .05;
					camera.position.y += ( mouseY - camera.position.y ) * .05;

					camera.lookAt( 0, 0.5, 0 );

					//raycaster
					if (heartObject) {
						raycaster.setFromCamera( pointer, camera );
						const intersects = raycaster.intersectObjects([heartObject]);
						if ( intersects.length > 0 ) {
							if ( INTERSECTED != intersects[ 0 ].object ) {
								if (INTERSECTED) {
									INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );
									bloomEffect.selection.delete(INTERSECTED)
								}
								INTERSECTED = intersects[ 0 ].object;
								INTERSECTED.currentHex = INTERSECTED.material.emissive.getHex();
								INTERSECTED.material.emissive.setHex( 0xff0000 );
								bloomEffect.selection.add(INTERSECTED)
							}
							document.body.style.cursor = "pointer";
						} else {
							if ( INTERSECTED ) {
								INTERSECTED.material.emissive.setHex( INTERSECTED.currentHex );
								bloomEffect.selection.delete(INTERSECTED)
							}
							INTERSECTED = null;
							document.body.style.cursor = "default";
						}
					}

					const time = clock.getElapsedTime();

					bloomEffect.luminanceMaterial.threshold = scale(Math.sin(time * 4), 0.05, 0.5);

					const delta = animClock.getDelta();
					mixer.update(delta);

					composer.render(delta)

				}
		}
		</script>

	</body>
</html>
